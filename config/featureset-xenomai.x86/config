# Kernel config for Xenomai 3.0-rc4, x86                              -*-conf-*-
#
# This config should be applied on top of a generic kernel config to,
# hopefully, create a working configuration for a Xenomai-patched
# kernel.
#
#
# General problem options; see
# http://xenomai.org/troubleshooting-a-dual-kernel-configuration/#kconf
#
# This option should not be enabled, except with x86.
#
# CONFIG_KGDB is not set
#
# This option which appeared in kernel 3.8 is forced off by I-pipe
# patches since 3.14 onward, as it is incompatible with interrupt
# pipelining, and has no upside for regular users. However, you have
# to manually disable it for older kernels when present. Common
# effects observed with this feature enabled include RCU-related
# kernel warnings during real-time activities, and pathologically
# high latencies.
#
# CONFIG_CONTEXT_TRACKING_FORCE is not set
#
#############################################
# Xenomai options
#
# Based on Gilles's config:
# http://www.xenomai.org/pipermail/xenomai/2013-January/027345.html
#
# Real-time sub-system
#
CONFIG_XENOMAI=y
CONFIG_XENO_GENERIC_STACKPOOL=y
CONFIG_XENO_FASTSYNCH=y
CONFIG_XENO_OPT_NUCLEUS=y
CONFIG_XENO_OPT_PERVASIVE=y
# CONFIG_XENO_OPT_PRIOCPL is not set
CONFIG_XENO_OPT_PIPELINE_HEAD=y
# CONFIG_XENO_OPT_SCHED_CLASSES is not set
CONFIG_XENO_OPT_PIPE=y
CONFIG_XENO_OPT_VFILE=y
CONFIG_XENO_OPT_PIPE_NRDEV=32
CONFIG_XENO_OPT_REGISTRY_NRSLOTS=512
# getting this during xeno-regression-test switchtest:
# Xenomai: xnthread_init: no stack for kernel thread 'rtk4/1'
#     (raise CONFIG_XENO_OPT_SYS_STACKPOOLSZ)
# From regression test:
# ioctl(RTTST_RTIOC_SWTEST_CREATE_KTASK): Cannot allocate memory
# Related:
# http://www.mail-archive.com/xenomai-help@gna.org/msg03869.html
# Quadrupling both params to be safe
# (Gilles uses 4096 for both values)
#CONFIG_XENO_OPT_SYS_HEAPSZ=256
CONFIG_XENO_OPT_SYS_HEAPSZ=1024
#CONFIG_XENO_OPT_SYS_STACKPOOLSZ=128
CONFIG_XENO_OPT_SYS_STACKPOOLSZ=512
CONFIG_XENO_OPT_SEM_HEAPSZ=12
CONFIG_XENO_OPT_GLOBAL_SEM_HEAPSZ=12
CONFIG_XENO_OPT_STATS=y
CONFIG_XENO_OPT_DEBUG=y
# CONFIG_XENO_OPT_DEBUG_NUCLEUS is not set
# CONFIG_XENO_OPT_DEBUG_XNLOCK is not set
# CONFIG_XENO_OPT_DEBUG_QUEUES is not set
# CONFIG_XENO_OPT_DEBUG_REGISTRY is not set
# CONFIG_XENO_OPT_DEBUG_TIMERS is not set
CONFIG_XENO_OPT_DEBUG_SYNCH_RELAX=y
CONFIG_XENO_OPT_WATCHDOG=y
CONFIG_XENO_OPT_WATCHDOG_TIMEOUT=4
CONFIG_XENO_OPT_SHIRQ=y
CONFIG_XENO_OPT_SELECT=y
CONFIG_XENO_OPT_HOSTRT=y

#
# Timing
#
CONFIG_XENO_OPT_TIMING_PERIODIC=y
CONFIG_XENO_OPT_TIMING_VIRTICK=1000
CONFIG_XENO_OPT_TIMING_SCHEDLAT=0

#
# Scalability
#
# CONFIG_XENO_OPT_SCALABLE_SCHED is not set
CONFIG_XENO_OPT_TIMER_LIST=y
# CONFIG_XENO_OPT_TIMER_HEAP is not set
# CONFIG_XENO_OPT_TIMER_WHEEL is not set

#
# Machine
#
CONFIG_XENO_HW_FPU=y

#
# SMI workaround
#
# CONFIG_XENO_HW_SMI_DETECT_DISABLE is not set
CONFIG_XENO_HW_SMI_DETECT=y
# CONFIG_XENO_HW_SMI_WORKAROUND is not set

#
# Interfaces
#
CONFIG_XENO_SKIN_NATIVE=y
CONFIG_XENO_OPT_NATIVE_PERIOD=0
CONFIG_XENO_OPT_NATIVE_PIPE=y
CONFIG_XENO_OPT_NATIVE_PIPE_BUFSZ=1024
CONFIG_XENO_OPT_NATIVE_SEM=y
CONFIG_XENO_OPT_NATIVE_EVENT=y
CONFIG_XENO_OPT_NATIVE_MUTEX=y
CONFIG_XENO_OPT_NATIVE_COND=y
CONFIG_XENO_OPT_NATIVE_QUEUE=y
CONFIG_XENO_OPT_NATIVE_BUFFER=y
CONFIG_XENO_OPT_NATIVE_HEAP=y
CONFIG_XENO_OPT_NATIVE_ALARM=y
CONFIG_XENO_OPT_NATIVE_MPS=y
# CONFIG_XENO_OPT_NATIVE_INTR is not set
# CONFIG_XENO_OPT_DEBUG_NATIVE is not set
CONFIG_XENO_SKIN_POSIX=y
CONFIG_XENO_OPT_POSIX_PERIOD=0
# CONFIG_XENO_OPT_POSIX_SHM is not set
# CONFIG_XENO_OPT_POSIX_INTR is not set
CONFIG_XENO_OPT_POSIX_SELECT=y
# CONFIG_XENO_OPT_DEBUG_POSIX is not set
CONFIG_XENO_SKIN_PSOS=m
CONFIG_XENO_OPT_PSOS_PERIOD=1000
# CONFIG_XENO_OPT_DEBUG_PSOS is not set
CONFIG_XENO_SKIN_UITRON=m
CONFIG_XENO_OPT_UITRON_PERIOD=1000
# CONFIG_XENO_OPT_DEBUG_UITRON is not set
CONFIG_XENO_SKIN_VRTX=m
CONFIG_XENO_OPT_VRTX_PERIOD=1000
CONFIG_XENO_SKIN_VXWORKS=m
CONFIG_XENO_OPT_VXWORKS_PERIOD=1000
# CONFIG_XENO_OPT_DEBUG_VXWORKS is not set
# CONFIG_XENO_OPT_NOWARN_DEPRECATED is not set
CONFIG_XENO_SKIN_RTDM=y
CONFIG_XENO_OPT_RTDM_PERIOD=0
CONFIG_XENO_OPT_RTDM_FILDES=128
CONFIG_XENO_OPT_RTDM_SELECT=y
# CONFIG_XENO_OPT_DEBUG_RTDM is not set
# CONFIG_XENO_OPT_DEBUG_RTDM_APPL is not set

#
# Drivers
#
CONFIG_XENO_DRIVERS_16550A=m
# CONFIG_XENO_DRIVERS_16550A_PIO is not set
# CONFIG_XENO_DRIVERS_16550A_MMIO is not set
CONFIG_XENO_DRIVERS_16550A_ANY=y
CONFIG_XENO_DRIVERS_16550A_PCI=y
CONFIG_XENO_DRIVERS_16550A_PCI_MOXA=y
CONFIG_XENO_DRIVERS_TIMERBENCH=y
CONFIG_XENO_DRIVERS_KLATENCY=m
CONFIG_XENO_DRIVERS_IRQBENCH=m
CONFIG_XENO_DRIVERS_SWITCHTEST=y
CONFIG_XENO_DRIVERS_RTDMTEST=m
CONFIG_XENO_DRIVERS_CAN=m
CONFIG_XENO_DRIVERS_CAN_DEBUG=y
# CONFIG_XENO_DRIVERS_CAN_LOOPBACK is not set
CONFIG_XENO_DRIVERS_CAN_RXBUF_SIZE=1024
CONFIG_XENO_DRIVERS_CAN_MAX_DEVICES=4
CONFIG_XENO_DRIVERS_CAN_MAX_RECEIVERS=16
CONFIG_XENO_DRIVERS_CAN_BUS_ERR=y
# CONFIG_XENO_DRIVERS_CAN_CALC_BITTIME_OLD is not set
CONFIG_XENO_DRIVERS_CAN_VIRT=m
# CONFIG_XENO_DRIVERS_CAN_FLEXCAN is not set
CONFIG_XENO_DRIVERS_CAN_SJA1000=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_ISA=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_MEM=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_PEAK_PCI=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_IXXAT_PCI=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_ADV_PCI=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_PLX_PCI=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_EMS_PCI=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_ESD_PCI=m
CONFIG_XENO_DRIVERS_CAN_SJA1000_PEAK_DNG=m
CONFIG_XENO_DRIVERS_ANALOGY=m
CONFIG_XENO_DRIVERS_ANALOGY_DEBUG=y
CONFIG_XENO_DRIVERS_ANALOGY_DEBUG_LEVEL=0
CONFIG_XENO_DRIVERS_ANALOGY_DRIVER_DEBUG_LEVEL=0
CONFIG_XENO_DRIVERS_ANALOGY_FAKE=m
CONFIG_XENO_DRIVERS_ANALOGY_8255=m
CONFIG_XENO_DRIVERS_ANALOGY_PARPORT=m
CONFIG_XENO_DRIVERS_ANALOGY_NI_MITE=m
CONFIG_XENO_DRIVERS_ANALOGY_NI_TIO=m
CONFIG_XENO_DRIVERS_ANALOGY_NI_MIO=m
CONFIG_XENO_DRIVERS_ANALOGY_NI_PCIMIO=m
CONFIG_XENO_DRIVERS_ANALOGY_NI_670x=m
CONFIG_XENO_DRIVERS_ANALOGY_NI_660x=m
CONFIG_XENO_DRIVERS_ANALOGY_S526=m
CONFIG_XENO_DRIVERS_RTIPC=y
CONFIG_XENO_DRIVERS_RTIPC_XDDP=y
CONFIG_XENO_DRIVERS_RTIPC_IDDP=y
CONFIG_XENO_OPT_IDDP_NRPORT=32
CONFIG_XENO_DRIVERS_RTIPC_BUFP=y
CONFIG_XENO_OPT_BUFP_NRPORT=32
#
# IPIPE options
#
CONFIG_IPIPE=y
#
# Build error:   #error "CONFIG_IPIPE_LEGACY must be switched off"
# CONFIG_IPIPE_LEGACY is not set
#
# CONFIG_IPIPE_DEBUG is not set
#
#
#######################################
# x86 kernel configuration
# http://xenomai.org/2014/06/configuring-for-x86-based-dual-kernels/
#
# This allows the CPU frequency to be modulated with workload, but
# many CPUs change the TSC counting frequency also, which makes it
# useless for accurate timing when the CPU clock can change. Also
# some CPUs can take several milliseconds to ramp up to full speed.
#
# CONFIG_CPU_FREQ
#
# Allows the CPU to enter deep sleep states, increasing the time it
# takes to get out of these sleep states, hence the latency of an
# idle system. Also, on some CPU, entering these deep sleep states
# causes the timers used by Xenomai to stop functioning.
#
# CONFIG_CPU_IDLE is not set
#
# The APM model assigns power management control to the BIOS, and
# BIOS code is never written with best latency in mind. If
# configured, APM routines are invoked with SMI priority, which
# bypasses the I-pipe entirely. Resorting to the Xenomai workaround
# for SMI won’t help here.
#
# CONFIG_APM is not set
#
# For systems with ACPI support in the BIOS, this ACPI sub-option
# installs an idle handler that uses ACPI C2 and C3 processor states to
# save power. The CPU must warm-up from these sleep states, increasing
# latency in ways dependent upon both the BIOS’s ACPI tables and
# code. You may be able to suppress the sleeping with idle=poll
# boot-arg, test to find out. With recents versions of Linux (probably
# starting around Linux 2.6.21), the acpi processor module disables the
# local APIC when loaded. This will cause Xenomai timer initialization
# to fail. This makes a second reason for disabling this option.
#
# CONFIG_ACPI_PROCESSOR is not set
#
# Just like CONFIG_ACPI_PROCESSOR, this idle driver sends the CPU into
# deep C states, also causing huge latencies because the APIC timer
# that Xenomai uses may not fire anymore.
#
# CONFIG_INTEL_IDLE is not set
#
#  This option may be enabled, provided the following operations on
#  interrupt lines are always done from a mere Linux context, aka
#  secondary mode, and never from the real-time mode: [...]
#
# CONFIG_PCI_MSI is not set
#
############################################
# Other changes
#
# $ switchtest -s 1000
# Xenomai/cobalt: __map_umm(): cannot open RTDM device /dev/rtdm/memdev-private:
#     Permission denied
# Xenomai/cobalt: init_bind(): cannot map private umm area: Permission denied
#                (CONFIG_DEVTMPFS_MOUNT not enabled?)
# https://xenomai.org/migrating-from-xenomai-2-x-to-3-x/#Application_interface
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
#
# [...]/testsuite/smokey: sched_setconfig_np(add-quota-group): Invalid argument
# http://www.xenomai.org/pipermail/xenomai/2014-September/031764.html
# This overrides the above from Gilles's old config.
CONFIG_XENO_OPT_SCHED_CLASSES=y
CONFIG_XENO_OPT_SCHED_WEAK=y
CONFIG_XENO_OPT_SCHED_TP=y
CONFIG_XENO_OPT_SCHED_SPORADIC=y
CONFIG_XENO_OPT_SCHED_QUOTA=y
#
# Enable autotune(1)
# http://www.xenomai.org/documentation/xenomai-3/html/man1/autotune/index.html
CONFIG_XENO_OPT_AUTOTUNE=y
#
# Disable FTRACE to improve latencies
# http://www.xenomai.org/pipermail/xenomai/2013-January/027272.html
# CONFIG_FTRACE is not set
# and dependent option
# CONFIG_KMEMCHECK is not set
#
# CONFIG_CPUMASK_OFFSTACK disables functions that pass cpumasks on
# the stack.  Xenomai uses set_cpus_allowed(), which takes a cpumask
# as an argument, in many places.  Disable this config and related
# configs.
#
# CONFIG_CPUMASK_OFFSTACK is not set
#
# CONFIG_MAXSMP turns CONFIG_CPUMASK_OFFSTACK on automatically
# CONFIG_MAXSMP is not set
#
# Upstream config sets CONFIG_NR_CPUS to 1024, which make config seems
# not to like when CONFIG_MAXSMP is off
CONFIG_NR_CPUS=8
#
# Jan's fix for x86 arch kernel oops:
# kernel BUG at mm/mmap.c:2313!
# invalid opcode: 0000 [#2] SMP 
# http://www.xenomai.org/pipermail/xenomai-help/2011-06/msg00197.html
# CONFIG_TRANSPARENT_HUGEPAGE is not set
#
# gpio-pch is broken
# http://www.xenomai.org/pipermail/xenomai/2013-January/027365.html
# CONFIG_GPIO_PCH is not set
#
# Gilles: CONFIG_PREEMPT_NONE, results in shorter worst case latencies
# http://permalink.gmane.org/gmane.linux.real-time.xenomai.users/18499
# https://github.com/zultron/kernel-rt-deb/issues/2
CONFIG_PREEMPT_NONE=y


############################################################
# Defaults from Xenomai-3.0
CONFIG_XENO_OPT_RR_QUANTUM=1000
CONFIG_XENO_OPT_PRIVATE_HEAPSZ=32
CONFIG_XENO_OPT_SHARED_HEAPSZ=32
CONFIG_XENO_OPT_NRTIMERS=128
CONFIG_XENO_OPT_TIMING_KSCHEDLAT=0
CONFIG_XENO_OPT_TIMING_IRQLAT=0
# CONFIG_XENO_OPT_DEBUG_COBALT is not set
# CONFIG_XENO_OPT_DEBUG_CONTEXT is not set
CONFIG_XENO_OPT_DEBUG_LOCKING=y
# CONFIG_XENO_OPT_DEBUG_USER is not set
# CONFIG_XENO_OPT_DEBUG_TRACE_RELAX is not set
CONFIG_XENO_OPT_RTDM_COMPAT_DEVNODE=y
# CONFIG_XENO_DRIVERS_NET is not set
# CONFIG_XENO_DRIVERS_ANALOGY_DEBUG_FTRACE is not set
# CONFIG_XENO_DRIVERS_UDD is not set
